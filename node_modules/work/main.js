var myutil = require('./myutil');
var trimHtml = require('trim-html')

var mysql = require('mysql');


var limitation = 50;//文章有多少字


var connection = mysql.createConnection({
	host:		'localhost',
	user:		'root',
	password: 	'3306',
	database:	'blog'
});
	
connection.connect();

exports.saveData = function(req,res)
{
	
	var article = {
		tittle		:	req.body.articleTittle,
		authorName	:	req.body.articleAuthor ||'lyle',
		publishTime	:	new Date(),
		content		:	req.body.articleBody
	}
	//console.log("收到数据 \n title:"+article.tittle+"\n"+"authorName:"+article.authorName+"\n"+article.content);
		
	var query = connection.query('insert into article set ?',article,function(err,result){
		if(err)
			console.log("数据库插入错误\n"+err);
		else
		{
			//console.log(JSON.stringify(result));
			res.redirect('list');
		}
	});	
	console.log(query.sql);
}
exports.getArticleList = function(res,number){
	var sql = 'select * from article order by publishTime desc limit '+number;
	console.log("执行sql:\n"+sql);
	connection.query(sql,function(err,results)
	{
		if(err)
		{
			console.log("数据库X查询错误\n"+err);
			return 0;
		}
		else
		{
			//console.log(results);	
			if(results.length>0)
			{	
				//console.log(results);	
				for(var i = 0; i < results.length; i++)
				{
					var trim = trimHtml(results[i].content, { limit: limitation });
					
					results[i].publishTime = myutil.getDate(results[i].publishTime);//更新时间格式
					results[i].content = trim.html;
					results[i].hasMore = 1;
					console.log("处理后的时间是:"+results[i].publishTime);
				}					
				res.render('list',{article:results});
			}	
		}
	});
	/*
	  `articleID` INT NOT NULL AUTO_INCREMENT,
	  `tittle` VARCHAR(500) NOT NULL COMMENT '标题',
	  `authorName` VARCHAR(100) NOT NULL,
	  `publishTime` DATETIME NULL,
	  `updateTime` DATETIME NULL,
	  `articleLength` INT NULL DEFAULT 0,
	  `visitCounter` INT NULL,
	  `isPicture` INT NULL,
	  `isFiles` INT NULL,
	  `content` TEXT NULL,
	  `hasMore` int, 后面添加,如果有更多内容就为1
	*/
}
exports.getOneArticle = function(req,res){
	var sql = 'select * from article where articleID ='+mysql.escape(req.params.id);
	//console.log(sql);
	connection.query(sql,function(err,results)
	{
		if(err)
		{
			console.log("数据库X查询错误\n"+err);
			return 0;
		}
		else
		{
			//console.log(results);	
			if(results.length>0)
			{	
				//console.log(results);	
				for(var i = 0; i < results.length; i++)
				{
					results[i].publishTime = myutil.getDate(results[i].publishTime);
					results[i].hasMore = 0;
					//console.log("处理后的时间是:"+results[i].publishTime);
				}
				res.render('list',{article:results});
			}	
		}
	});
}
