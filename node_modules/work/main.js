var myutil = require('./myutil');
var trimHtml = require('trim-html');
var config = require('./configuration');
var mysql = require('mysql');


var limitation = config.limitation;//每篇文章显示多少个字的摘要


var connection = mysql.createConnection({
	host:		config.host,
	user:		config.user,
	password: 	config.password,
	database:	config.database
});
	
connection.connect();

exports.saveData = function(req,res)
{
	
	var article = {
		tittle		:	req.body.articleTittle,
		authorName	:	req.body.articleAuthor ||'lyle',
		publishTime	:	new Date(),
		content		:	req.body.articleBody
	}
	//console.log("收到数据 \n title:"+article.tittle+"\n"+"authorName:"+article.authorName+"\n"+article.content);
		
	var query = connection.query('insert into article set ?',article,function(err,result){
		if(err)            
			console.log("数据库插入错误\n"+err);
		else
		{
			//console.log(JSON.stringify(result));
			res.redirect('list');
		}
	});	
	console.log(query.sql);
}
exports.getArticleList = function(req,res){
	var articleNumber = config.articleNumber;
	var pageNumber = req.query.page | 0;
	var sqlQueryCount = 'select count(articleID) from article';
	var sql = 'select * from article order by publishTime desc limit ';
	
	connection.query(sqlQueryCount,function(err,results){
		if(err)
		{
			console.log("查询文章列表总条数时出错!\n"+err);
			res.send("您要查询的页面是:"+pageNumber+"页,发生错误");
			return 0;
		}
		if(results)
		{
			//console.log("查询文章列表总条数成功:"+JSON.stringify(results));
			//console.log("查询成功"+results[0]["count(articleID)"]);
			var allArticle  = results[0]["count(articleID)"];
			var totalPage = Math.floor(allArticle/articleNumber);
			var firstArticleOfPage = pageNumber*articleNumber; 
			//文章总数除以每页显示的文章数,向下取整就是一共有多少页,页码是从0开始的,
			//再乘以当前页码就是当前页最开始一条文章
			//传过来的页码要求也从0开始;
			sql = sql+ firstArticleOfPage+','+articleNumber;
			console.log("执行sql:\n"+sql);
			connection.query(sql,function(err,results){
				if(err)
				{
					console.log("数据库X查询错误\n"+err);
					return 0;
				}
				else
				{
					//console.log(results);	
					if(results.length>0)
					{	
						//console.log(results);	
						for(var i = 0; i < results.length; i++)
						{
							var trim = trimHtml(results[i].content, { limit: limitation });
							
							results[i].publishTime = myutil.getDate(results[i].publishTime);//更新时间格式
							results[i].content = trim.html;
							results[i].hasMore = 1;
							//console.log("处理后的时间是:"+results[i].publishTime);
						}					
						res.render('list',
						{
							article		:	results,
							aboutMe		:	config.aboutMe,
							thisPage	:	pageNumber,		//第一页从0开始
							totalPage	:	totalPage,		//总页数从0开始,totalPage包含第0页
							pagination	:	config.pagination//分页显示多少个按钮
						});
					}	
				}
			});
		}
	});
	
	/*
	  `articleID` INT NOT NULL AUTO_INCREMENT,
	  `tittle` VARCHAR(500) NOT NULL COMMENT '标题',
	  `authorName` VARCHAR(100) NOT NULL,
	  `publishTime` DATETIME NULL,
	  `updateTime` DATETIME NULL,
	  `articleLength` INT NULL DEFAULT 0,
	  `visitCounter` INT NULL,
	  `isPicture` INT NULL,
	  `isFiles` INT NULL,
	  `content` TEXT NULL,
	  `hasMore` int, 后面添加,如果有更多内容就为1
	*/
}
exports.getOneArticle = function(req,res){
	var sql = 'select * from article where articleID ='+mysql.escape(req.params.id);
	//console.log(sql);
	connection.query(sql,function(err,results)
	{
		if(err)
		{
			console.log("数据库X查询错误\n"+err);
			return 0;
		}
		else
		{
			//console.log(results);	
			if(results.length>0)
			{	

				results[0].publishTime = myutil.getDate(results[0].publishTime);
				results[0].hasMore = 0;
				//console.log("处理后的时间是:"+results[i].publishTime);
				res.render('oneArticle',{article:results,aboutMe:config.aboutMe});
			}	
		}
	});
}
